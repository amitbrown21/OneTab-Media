<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UME - Ultimate Media Extension - Comprehensive Test Suite</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-section h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .test-section h3 {
            color: #555;
            margin-top: 25px;
            border-left: 4px solid #007bff;
            padding-left: 15px;
        }
        
        video, audio {
            width: 100%;
            max-width: 500px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        
        .controls {
            margin: 15px 0;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        button.success {
            background: #28a745;
        }
        
        button.warning {
            background: #ffc107;
            color: #212529;
        }
        
        button.danger {
            background: #dc3545;
        }
        
        .status {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            border-left: 4px solid #007bff;
        }
        
        .status.success {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .status.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .status.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .web-audio-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        #oscilloscope {
            width: 100%;
            height: 100px;
            background: #000;
            border: 1px solid #ccc;
        }
        
        .keyboard-test {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }
        
        .keyboard-hint {
            font-family: monospace;
            background: #343a40;
            color: #fff;
            padding: 5px 10px;
            border-radius: 3px;
            margin: 0 5px;
            font-weight: bold;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
            font-weight: bold;
        }
        
        .test-result.pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .test-result.fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .volume-indicator {
            display: inline-block;
            width: 200px;
            height: 20px;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 10px;
            position: relative;
            vertical-align: middle;
            margin: 0 10px;
        }
        
        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 100%;
        }
        
        .instructions {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .feature-highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="feature-highlight">
        <h1>üöÄ UME - Ultimate Media Extension - Comprehensive Test Suite</h1>
        <p>Test all features: Media Tab Tracking, Speed Controls, Volume Booster, Keyboard Shortcuts, Settings System</p>
    </div>
    
    <div class="instructions">
        <h3>üß™ Testing Instructions</h3>
        <ol>
            <li><strong>Install the Extension:</strong> Make sure UME extension is loaded in your browser</li>
            <li><strong>Open Extension Popup:</strong> Click the extension icon to see active media tabs</li>
            <li><strong>Test Features:</strong> Use the sections below to test each feature systematically</li>
            <li><strong>Check Console:</strong> Open browser developer tools to see debug messages</li>
            <li><strong>Multi-Tab Testing:</strong> Open this page in multiple tabs to test cross-tab functionality</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>üìπ Speed Control & Media Detection Test</h2>
        <p>Test video speed controls, markers, and media tab tracking:</p>
        
        <video controls id="testVideo">
            <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
            <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        
        <h3>Basic Controls</h3>
        <div class="controls">
            <button onclick="playVideo()">‚ñ∂Ô∏è Play Video</button>
            <button onclick="pauseVideo()">‚è∏Ô∏è Pause Video</button>
            <button onclick="muteVideo()">üîá Toggle Mute</button>
        </div>
        
        <h3>Speed & Marker Controls</h3>
        <div class="controls">
            <button onclick="setSpeed(0.5)" class="warning">üêå 0.5x Speed</button>
            <button onclick="setSpeed(1.0)" class="success">‚û°Ô∏è Normal Speed</button>
            <button onclick="setSpeed(1.5)" class="warning">‚ö° 1.5x Speed</button>
            <button onclick="setSpeed(2.0)" class="danger">üöÄ 2.0x Speed</button>
        </div>
        
        <div class="controls">
            <button onclick="setMarker()" class="success">üìç Set Marker</button>
            <button onclick="jumpToMarker()">üéØ Jump to Marker</button>
            <button onclick="rewind(10)">‚è™ Rewind 10s</button>
            <button onclick="advance(10)">‚è© Advance 10s</button>
        </div>
        
        <div class="keyboard-test">
            <h4>üéπ Keyboard Shortcuts Test</h4>
            <p>Click on the video above, then test these keyboard shortcuts:</p>
            <ul>
                <li><span class="keyboard-hint">V</span> - Show/Hide Speed Controller</li>
                <li><span class="keyboard-hint">S</span> - Decrease Speed (-0.25x)</li>
                <li><span class="keyboard-hint">D</span> - Increase Speed (+0.25x)</li>
                <li><span class="keyboard-hint">R</span> - Reset to 1.0x Speed</li>
                <li><span class="keyboard-hint">G</span> - Fast Speed (1.8x)</li>
                <li><span class="keyboard-hint">Z</span> - Rewind 10 seconds</li>
                <li><span class="keyboard-hint">X</span> - Advance 10 seconds</li>
                <li><span class="keyboard-hint">M</span> - Set Marker</li>
                <li><span class="keyboard-hint">J</span> - Jump to Marker</li>
                <li><span class="keyboard-hint">‚Üë</span> - Volume Up</li>
                <li><span class="keyboard-hint">‚Üì</span> - Volume Down</li>
            </ul>
        </div>
        
        <div class="status" id="videoStatus">
            Status: Ready to play
        </div>
        
        <div id="speedTestResults"></div>
    </div>
    
    <div class="test-section">
        <h2>üéµ Audio Test & Volume Booster</h2>
        <p>Test audio playback and volume enhancement features:</p>
        
        <audio controls id="testAudio">
            <source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.wav" type="audio/wav">
            <source src="https://www.w3schools.com/html/horse.ogg" type="audio/ogg">
            <source src="https://www.w3schools.com/html/horse.mp3" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
        
        <h3>Basic Audio Controls</h3>
        <div class="controls">
            <button onclick="playAudio()">‚ñ∂Ô∏è Play Audio</button>
            <button onclick="pauseAudio()">‚è∏Ô∏è Pause Audio</button>
            <button onclick="muteAudio()">üîá Toggle Mute</button>
        </div>
        
        <h3>üîä Volume Booster Testing</h3>
        <div class="warning-box">
            <strong>‚ö†Ô∏è Volume Booster Warning:</strong> Start with low volume on your speakers/headphones. 
            The volume booster can make audio significantly louder and may cause hearing damage at high levels.
        </div>
        
        <div class="controls">
            <button onclick="setVolume(0.5)" class="success">üîá 50% Volume</button>
            <button onclick="setVolume(1.0)" class="success">üîä 100% Volume</button>
            <button onclick="setVolume(1.5)" class="warning">üì¢ 150% Volume</button>
            <button onclick="setVolume(2.0)" class="warning">üìØ 200% Volume</button>
            <button onclick="setVolume(3.0)" class="danger">üö® 300% Volume</button>
        </div>
        
        <div style="margin: 15px 0;">
            <label>Current Volume: 
                <span id="volumeDisplay">100%</span>
                <div class="volume-indicator">
                    <div class="volume-bar" id="volumeBar" style="width: 100%;"></div>
                </div>
            </label>
        </div>
        
        <div class="keyboard-test">
            <h4>Volume Control Testing</h4>
            <p><strong>üîß FIXED:</strong> Popup volume controls now work properly!</p>
            <div class="test-instructions">
                <h5>Test Both Methods:</h5>
                <ol>
                    <li><strong>Keyboard Shortcuts:</strong> Focus on audio above, then use ‚Üë/‚Üì arrows</li>
                    <li><strong>Extension Popup:</strong> Click extension icon ‚Üí Use Volume Booster section</li>
                </ol>
            </div>
            <ul>
                <li><span class="keyboard-hint">‚Üë</span> - Increase Volume (+10%)</li>
                <li><span class="keyboard-hint">‚Üì</span> - Decrease Volume (-10%)</li>
                <li><strong>Popup Slider:</strong> Drag from 10% to 500%</li>
                <li><strong>Popup Buttons:</strong> -10%, 100%, +10%</li>
                <li><strong>Per-Domain:</strong> Settings saved for each website</li>
                <li><strong>Options Page:</strong> Customize volume shortcuts in Settings ‚Üí Keyboard Shortcuts</li>
            </ul>
            <div class="test-result pass">
                ‚úÖ Volume shortcuts now appear in extension options page!
            </div>
        </div>
        
        <div class="status" id="audioStatus">
            Status: Ready to play
        </div>
    </div>
    
    <div class="test-section">
        <h2>üéõÔ∏è Web Audio API Test</h2>
        <p>Test with Web Audio API generated sounds:</p>
        
        <canvas id="oscilloscope" width="800" height="100"></canvas>
        
        <div class="web-audio-controls">
            <button onclick="playTone(440)" id="playToneBtn">üéµ Play 440Hz Tone</button>
            <button onclick="playTone(880)">üéµ Play 880Hz Tone</button>
            <button onclick="playNoise()">üì¢ Play White Noise</button>
            <button onclick="stopWebAudio()" id="stopBtn" disabled>‚èπÔ∏è Stop Audio</button>
        </div>
        
        <div class="status" id="webAudioStatus">
            Status: Web Audio API ready
        </div>
    </div>
    
    <div class="test-section">
        <h2>üîÑ Dynamic Media Test</h2>
        <p>Test dynamic content loading (simulates SPA behavior):</p>
        
        <div id="dynamicContainer">
            <!-- Dynamic content will be inserted here -->
        </div>
        
        <div class="controls">
            <button onclick="addDynamicVideo()">‚ûï Add Dynamic Video</button>
            <button onclick="addDynamicAudio()">‚ûï Add Dynamic Audio</button>
            <button onclick="clearDynamic()">üóëÔ∏è Clear Dynamic Content</button>
        </div>
        
        <div class="status" id="dynamicStatus">
            Status: No dynamic content
        </div>
    </div>
    
    <div class="test-section">
        <h2>üìä Media Tab Tracking Test</h2>
        <p>Test the fixed media tab tracking functionality:</p>
        
        <div class="instructions">
            <h4>üß™ Paused Media Persistence Test</h4>
            <div class="test-result pass">
                ‚úÖ <strong>CRITICAL FIX:</strong> Simultaneous playback issue resolved! ActiveMediaTabs no longer clear unexpectedly!
            </div>
            <div class="test-warning">
                ‚úÖ <strong>FIXED:</strong> Ultra-conservative tracking - paused media tabs NEVER disappear based on time!
            </div>
            <ol>
                <li><strong>Play Media:</strong> Start playing video or audio above ‚Üí Check extension popup shows this tab</li>
                <li><strong>Pause Media:</strong> Pause the media ‚Üí Check popup still shows tab (with paused status)</li>
                <li><strong>Wait Hours/Days:</strong> Leave media paused ‚Üí Tab should ALWAYS be visible in popup</li>
                <li><strong>Navigate Same Domain:</strong> Change URL on same domain ‚Üí Tab should remain tracked</li>
                <li><strong>Navigate Different Domain:</strong> Go to different website ‚Üí Only then should tab be removed</li>
                <li><strong>Close Tab:</strong> Close the browser tab ‚Üí Tab should be removed from popup immediately</li>
            </ol>
            
            <h4>üß™ Multi-Tab Tracking Test</h4>
            <ol>
                <li><strong>Open Multiple Tabs:</strong> Open this test page in 3-4 browser tabs</li>
                <li><strong>Play Different Media:</strong> Start playing different media in each tab</li>
                <li><strong>Check Extension Popup:</strong> Click extension icon - all tabs with media should be listed</li>
                <li><strong>Pause Some Media:</strong> Pause media in some tabs ‚Üí All tabs should still be tracked</li>
                <li><strong>Close Tabs:</strong> Close some tabs ‚Üí They should be removed from popup immediately</li>
            </ol>
            
            <h4>üß™ Simultaneous Playback Prevention Test</h4>
            <div class="test-result pass">
                ‚úÖ <strong>ROOT CAUSE FIXED:</strong> ActiveMediaTabs no longer gets cleared inappropriately!
            </div>
            <ol>
                <li><strong>Open 2+ Tabs:</strong> Open this test page in multiple browser tabs</li>
                <li><strong>Play in One Tab:</strong> Start playing media in one tab</li>
                <li><strong>Switch to Another Tab:</strong> Go to a different tab with media</li>
                <li><strong>Try Playing:</strong> Attempt to play media ‚Üí Should pause first tab automatically</li>
                <li><strong>Wait & Test:</strong> Wait a few minutes, try again ‚Üí Should NEVER play simultaneously</li>
                <li><strong>Check Console:</strong> No "activeMediaTabs.clear()" or unexpected deletions should occur</li>
            </ol>
            
            <div class="test-result pass">
                <strong>Fixed Issues:</strong>
                <ul>
                    <li>‚ùå Extension startup clearing all tracked tabs ‚Üí ‚úÖ Tabs preserved across restarts</li>
                    <li>‚ùå Media ending removing tabs ‚Üí ‚úÖ Tabs kept for potential replay</li>
                    <li>‚ùå Communication failures removing tabs ‚Üí ‚úÖ Tabs kept despite errors</li>
                </ul>
            </div>
        </div>
        
        <div class="test-grid">
            <div class="controls">
                <button onclick="testTabTracking()" class="success">üîç Test Tab Tracking</button>
                <button onclick="simulateUrlChange()" class="warning">üîÑ Simulate SPA Navigation</button>
                <button onclick="checkExtensionPopup()" class="warning">üìã Check Extension Popup</button>
            </div>
        </div>
        
        <div class="status" id="tabTrackingStatus">
            Status: Ready to test tab tracking
        </div>
        
        <div id="tabTrackingResults"></div>
    </div>

    <div class="test-section">
        <h2>‚öôÔ∏è Settings System Test</h2>
        <p>Test settings synchronization and persistence:</p>
        
        <div class="instructions">
            <h4>Settings Test Procedure</h4>
            <ol>
                <li>Right-click extension icon ‚Üí Options (or go to chrome://extensions)</li>
                <li>Modify various settings (speed defaults, keyboard shortcuts, blacklist, volume booster)</li>
                <li>Save settings and reload this page</li>
                <li>Test that your changes are applied to media elements</li>
                <li>Test settings sync across browser profiles/devices (if signed in)</li>
            </ol>
        </div>
        
        <div class="controls">
            <button onclick="testSettingsLoad()" class="success">üì• Test Settings Load</button>
            <button onclick="testSettingsSync()" class="warning">üîÑ Test Settings Sync</button>
            <button onclick="resetToDefaults()" class="danger">üîÑ Reset to Defaults</button>
        </div>
        
        <div class="status" id="settingsStatus">
            Status: Ready to test settings
        </div>
        
        <div id="settingsTestResults"></div>
    </div>

    <div class="test-section">
        <h2>üß™ Automated Test Results</h2>
        <p>Automated tests for core functionality:</p>
        
        <div class="controls">
            <button onclick="runAllTests()" class="success">‚ñ∂Ô∏è Run All Tests</button>
            <button onclick="runSpeedTests()" class="warning">‚ö° Speed Tests</button>
            <button onclick="runVolumeTests()" class="warning">üîä Volume Tests</button>
            <button onclick="runKeyboardTests()" class="warning">‚å®Ô∏è Keyboard Tests</button>
        </div>
        
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h2>üìã Manual Testing Checklist</h2>
        <div class="instructions">
            <h4>Complete Feature Testing Guide</h4>
            
            <h5>‚úÖ Basic Extension Functionality</h5>
            <ul>
                <li>Extension loads without errors in browser console</li>
                <li>Extension popup shows active media tabs correctly</li>
                <li>One-tab-playing policy works (starting media in new tab pauses others)</li>
                <li>Extension can be enabled/disabled via popup toggle</li>
            </ul>
            
            <h5>‚úÖ Speed Control Features</h5>
            <ul>
                <li>Speed controller overlay appears on video hover (if enabled)</li>
                <li>All keyboard shortcuts work correctly (V, S, D, R, G, Z, X)</li>
                <li>Speed changes are applied immediately and visually</li>
                <li>Speed settings persist across page refreshes (if remember speed enabled)</li>
                <li>Speed controls work on both video and audio elements</li>
            </ul>
            
            <h5>‚úÖ Marker Functionality</h5>
            <ul>
                <li>M key sets marker at current video position</li>
                <li>J key jumps to previously set marker</li>
                <li>Markers persist for the current URL/video source</li>
                <li>Visual notifications appear when setting/jumping to markers</li>
            </ul>
            
            <h5>‚úÖ Volume Booster Features</h5>
            <ul>
                <li>Volume booster initializes without Web Audio API errors</li>
                <li>Up/Down arrow keys adjust volume beyond 100%</li>
                <li>Volume changes are applied immediately</li>
                <li>Per-domain volume settings are remembered</li>
                <li>Volume respects safety limit (max 5.0x/500%)</li>
                <li>Audio context resumes on user interaction</li>
            </ul>
            
            <h5>‚úÖ Settings System</h5>
            <ul>
                <li>Options page loads without errors</li>
                <li>All settings save successfully</li>
                <li>Settings changes are applied to content scripts immediately</li>
                <li>Settings persist across browser restarts</li>
                <li>Default settings are applied on fresh install</li>
                <li>Settings validation prevents invalid values</li>
            </ul>
            
            <h5>‚úÖ Media Tab Tracking</h5>
            <ul>
                <li>Tabs with media remain tracked for extended periods (2+ hours)</li>
                <li>SPA navigation doesn't remove tabs from tracking</li>
                <li>Only hostname changes remove tabs from tracking</li>
                <li>Closed tabs are cleaned up properly</li>
                <li>Extension popup shows correct tab count and titles</li>
            </ul>
            
            <h5>‚úÖ Cross-Browser Compatibility</h5>
            <ul>
                <li>All features work in Chrome (Manifest V3)</li>
                <li>All features work in Firefox (Manifest V2)</li>
                <li>No browser-specific API issues</li>
                <li>Storage sync works correctly in both browsers</li>
            </ul>
        </div>
    </div>

    <script>
        // Global test state
        let testResults = [];
        let currentMarker = null;
        let testVolume = 1.0;
        
        // HTML5 Video Controls
        const video = document.getElementById('testVideo');
        const videoStatus = document.getElementById('videoStatus');
        
        function playVideo() {
            video.play();
            updateVideoStatus();
        }
        
        function pauseVideo() {
            video.pause();
            updateVideoStatus();
        }
        
        function muteVideo() {
            video.muted = !video.muted;
            updateVideoStatus();
        }
        
        function updateVideoStatus() {
            const speed = video.playbackRate || 1.0;
            const volume = testVolume || 1.0;
            const time = formatTime(video.currentTime || 0);
            const duration = formatTime(video.duration || 0);
            
            videoStatus.innerHTML = `
                Status: ${video.paused ? 'Paused' : 'Playing'} | 
                Speed: ${speed}x | 
                Volume: ${(volume * 100).toFixed(0)}% | 
                Time: ${time}/${duration}
                ${video.muted ? ' | MUTED' : ''}
            `;
        }
        
        // Speed Control Functions
        function setSpeed(speed) {
            video.playbackRate = speed;
            updateVideoStatus();
            showTestResult(`Speed set to ${speed}x`, 'success');
        }
        
        function setMarker() {
            currentMarker = video.currentTime;
            showTestResult(`Marker set at ${formatTime(currentMarker)}`, 'success');
            updateVideoStatus();
        }
        
        function jumpToMarker() {
            if (currentMarker !== null) {
                video.currentTime = currentMarker;
                showTestResult(`Jumped to marker at ${formatTime(currentMarker)}`, 'success');
            } else {
                showTestResult('No marker set', 'error');
            }
            updateVideoStatus();
        }
        
        function rewind(seconds) {
            video.currentTime = Math.max(0, video.currentTime - seconds);
            showTestResult(`Rewound ${seconds} seconds`, 'success');
            updateVideoStatus();
        }
        
        function advance(seconds) {
            video.currentTime = Math.min(video.duration || 0, video.currentTime + seconds);
            showTestResult(`Advanced ${seconds} seconds`, 'success');
            updateVideoStatus();
        }
        
        // Video event listeners
        video.addEventListener('play', updateVideoStatus);
        video.addEventListener('pause', updateVideoStatus);
        video.addEventListener('ended', updateVideoStatus);
        video.addEventListener('timeupdate', updateVideoStatus);
        video.addEventListener('ratechange', updateVideoStatus);
        
        // HTML5 Audio Controls
        const audio = document.getElementById('testAudio');
        const audioStatus = document.getElementById('audioStatus');
        const volumeDisplay = document.getElementById('volumeDisplay');
        const volumeBar = document.getElementById('volumeBar');
        
        function playAudio() {
            audio.play();
            updateAudioStatus();
        }
        
        function pauseAudio() {
            audio.pause();
            updateAudioStatus();
        }
        
        function muteAudio() {
            audio.muted = !audio.muted;
            updateAudioStatus();
        }
        
        function updateAudioStatus() {
            const volume = testVolume || 1.0;
            const time = formatTime(audio.currentTime || 0);
            const duration = formatTime(audio.duration || 0);
            
            audioStatus.innerHTML = `
                Status: ${audio.paused ? 'Paused' : 'Playing'} | 
                Volume: ${(volume * 100).toFixed(0)}% | 
                Time: ${time}/${duration}
                ${audio.muted ? ' | MUTED' : ''}
            `;
        }
        
        // Volume Control Functions
        function setVolume(volume) {
            testVolume = volume;
            updateVolumeDisplay(volume);
            updateAudioStatus();
            updateVideoStatus();
            
            // Note: This tests the UI - actual volume boost would be handled by extension
            showTestResult(`Volume set to ${(volume * 100).toFixed(0)}%`, volume > 1 ? 'warning' : 'success');
            
            if (volume > 2.0) {
                showTestResult('‚ö†Ô∏è HIGH VOLUME WARNING - Be careful!', 'error');
            }
        }
        
        function updateVolumeDisplay(volume) {
            const percentage = Math.min(100, (volume / 5.0) * 100); // Scale to 5.0x max
            const displayPercent = (volume * 100).toFixed(0);
            
            if (volumeDisplay) {
                volumeDisplay.textContent = `${displayPercent}%`;
            }
            
            if (volumeBar) {
                volumeBar.style.width = `${percentage}%`;
            }
        }
        
        // Audio event listeners
        audio.addEventListener('play', updateAudioStatus);
        audio.addEventListener('pause', updateAudioStatus);
        audio.addEventListener('ended', updateAudioStatus);
        audio.addEventListener('timeupdate', updateAudioStatus);
        
        // Web Audio API Controls
        let audioContext = null;
        let oscillator = null;
        let gainNode = null;
        let analyser = null;
        let animationId = null;
        
        const webAudioStatus = document.getElementById('webAudioStatus');
        const canvas = document.getElementById('oscilloscope');
        const canvasCtx = canvas.getContext('2d');
        
        function initWebAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.connect(audioContext.destination);
            }
        }
        
        function playTone(frequency) {
            stopWebAudio();
            initWebAudio();
            
            oscillator = audioContext.createOscillator();
            gainNode = audioContext.createGain();
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            
            oscillator.connect(gainNode);
            gainNode.connect(analyser);
            
            oscillator.start();
            
            document.getElementById('playToneBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            webAudioStatus.textContent = `Status: Playing ${frequency}Hz tone`;
            
            drawOscilloscope();
        }
        
        function playNoise() {
            stopWebAudio();
            initWebAudio();
            
            // Create white noise using ScriptProcessorNode
            const bufferSize = 4096;
            const noiseNode = audioContext.createScriptProcessor(bufferSize, 0, 1);
            
            noiseNode.onaudioprocess = function(e) {
                const output = e.outputBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    output[i] = Math.random() * 2 - 1;
                }
            };
            
            gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            
            noiseNode.connect(gainNode);
            gainNode.connect(analyser);
            
            oscillator = noiseNode; // Store reference for cleanup
            
            document.getElementById('playToneBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            webAudioStatus.textContent = 'Status: Playing white noise';
            
            drawOscilloscope();
        }
        
        function stopWebAudio() {
            if (oscillator) {
                try {
                    if (oscillator.stop) {
                        oscillator.stop();
                    } else if (oscillator.disconnect) {
                        oscillator.disconnect();
                    }
                } catch (e) {
                    console.log('Error stopping oscillator:', e);
                }
                oscillator = null;
            }
            
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            document.getElementById('playToneBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            webAudioStatus.textContent = 'Status: Web Audio stopped';
            
            // Clear canvas
            canvasCtx.fillStyle = 'black';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        function drawOscilloscope() {
            if (!analyser) return;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            function draw() {
                animationId = requestAnimationFrame(draw);
                
                analyser.getByteTimeDomainData(dataArray);
                
                canvasCtx.fillStyle = 'black';
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
                
                canvasCtx.lineWidth = 2;
                canvasCtx.strokeStyle = '#00ff00';
                canvasCtx.beginPath();
                
                const sliceWidth = canvas.width / bufferLength;
                let x = 0;
                
                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * canvas.height / 2;
                    
                    if (i === 0) {
                        canvasCtx.moveTo(x, y);
                    } else {
                        canvasCtx.lineTo(x, y);
                    }
                    
                    x += sliceWidth;
                }
                
                canvasCtx.stroke();
            }
            
            draw();
        }
        
        // Dynamic Content Controls
        const dynamicContainer = document.getElementById('dynamicContainer');
        const dynamicStatus = document.getElementById('dynamicStatus');
        let dynamicCounter = 0;
        
        function addDynamicVideo() {
            dynamicCounter++;
            const videoElement = document.createElement('video');
            videoElement.controls = true;
            videoElement.style.width = '100%';
            videoElement.style.maxWidth = '400px';
            videoElement.style.margin = '10px 0';
            videoElement.id = `dynamicVideo${dynamicCounter}`;
            
            videoElement.innerHTML = `
                <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4" type="video/mp4">
                <source src="https://www.w3schools.com/html/movie.mp4" type="video/mp4">
                Your browser does not support the video tag.
            `;
            
            const label = document.createElement('p');
            label.textContent = `Dynamic Video ${dynamicCounter}:`;
            
            dynamicContainer.appendChild(label);
            dynamicContainer.appendChild(videoElement);
            
            dynamicStatus.textContent = `Status: Added dynamic video ${dynamicCounter}`;
            
            // Add event listeners
            videoElement.addEventListener('play', () => {
                console.log(`Dynamic video ${dynamicCounter} started playing`);
            });
        }
        
        function addDynamicAudio() {
            dynamicCounter++;
            const audioElement = document.createElement('audio');
            audioElement.controls = true;
            audioElement.style.width = '100%';
            audioElement.style.maxWidth = '400px';
            audioElement.style.margin = '10px 0';
            audioElement.id = `dynamicAudio${dynamicCounter}`;
            
            audioElement.innerHTML = `
                <source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.wav" type="audio/wav">
                <source src="https://www.w3schools.com/html/horse.mp3" type="audio/mpeg">
                Your browser does not support the audio element.
            `;
            
            const label = document.createElement('p');
            label.textContent = `Dynamic Audio ${dynamicCounter}:`;
            
            dynamicContainer.appendChild(label);
            dynamicContainer.appendChild(audioElement);
            
            dynamicStatus.textContent = `Status: Added dynamic audio ${dynamicCounter}`;
            
            // Add event listeners
            audioElement.addEventListener('play', () => {
                console.log(`Dynamic audio ${dynamicCounter} started playing`);
            });
        }
        
        function clearDynamic() {
            dynamicContainer.innerHTML = '';
            dynamicCounter = 0;
            dynamicStatus.textContent = 'Status: Cleared all dynamic content';
        }
        
        // Test Helper Functions
        function formatTime(seconds) {
            if (!seconds || seconds === Infinity) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function showTestResult(message, type = 'info') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            
            const container = document.getElementById('testResults') || document.getElementById('speedTestResults') || document.body;
            container.appendChild(resultDiv);
            
            // Auto-scroll to result
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Store in global results
            testResults.push({ time: Date.now(), message, type });
        }
        
        // Tab Tracking Test Functions
        function testTabTracking() {
            showTestResult('Testing tab tracking functionality...', 'info');
            
            // Start playing media to ensure tab gets tracked
            if (!video.paused) {
                pauseVideo();
                setTimeout(() => playVideo(), 500);
            } else {
                playVideo();
            }
            
            showTestResult('Tab should now be tracked by extension. Check extension popup.', 'success');
            
            document.getElementById('tabTrackingStatus').innerHTML = `
                Status: Tab tracking test initiated. 
                <br>1. Check extension popup for this tab
                <br>2. Wait 10+ minutes and check again
                <br>3. Navigate within site and verify tab remains tracked
            `;
        }
        
        function simulateUrlChange() {
            // Simulate SPA navigation by changing URL parameters
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('test', Date.now());
            newUrl.searchParams.set('spa_nav', 'true');
            
            history.pushState({}, '', newUrl);
            
            showTestResult('URL changed (SPA navigation). Tab should remain tracked.', 'warning');
            
            document.getElementById('tabTrackingStatus').innerHTML = `
                Status: Simulated SPA navigation to ${newUrl.pathname}${newUrl.search}
                <br>Tab should STILL be tracked in extension popup.
            `;
        }
        
        function checkExtensionPopup() {
            showTestResult('Please manually check extension popup to verify tab tracking.', 'info');
            
            document.getElementById('tabTrackingResults').innerHTML = `
                <div class="instructions">
                    <h4>Manual Verification Steps:</h4>
                    <ol>
                        <li>Click the UME extension icon in browser toolbar</li>
                        <li>Verify this tab is listed with media</li>
                        <li>Note the tab title and URL</li>
                        <li>Try switching tabs via popup</li>
                        <li>Test pause/play controls in popup</li>
                    </ol>
                </div>
            `;
        }
        
        // Settings Test Functions
        function testSettingsLoad() {
            showTestResult('Testing settings load...', 'info');
            
            // Try to access extension settings if available
            try {
                if (typeof chrome !== 'undefined' && chrome.storage) {
                    chrome.storage.sync.get(null, (settings) => {
                        if (chrome.runtime.lastError) {
                            showTestResult('Cannot access extension settings directly from web page', 'warning');
                        } else {
                            showTestResult(`Settings loaded: ${Object.keys(settings).length} settings found`, 'success');
                        }
                    });
                } else {
                    showTestResult('Extension storage API not available on web page', 'warning');
                }
            } catch (error) {
                showTestResult('Settings test requires extension context', 'warning');
            }
            
            document.getElementById('settingsStatus').innerHTML = `
                Status: Settings test initiated. Check browser console for details.
                <br>Go to extension Options page to verify settings load/save correctly.
            `;
        }
        
        function testSettingsSync() {
            showTestResult('To test settings sync:', 'info');
            showTestResult('1. Change settings in options page', 'info');
            showTestResult('2. Reload this page', 'info');
            showTestResult('3. Test that changes are applied', 'info');
            
            document.getElementById('settingsTestResults').innerHTML = `
                <div class="instructions">
                    <h4>Settings Sync Test Steps:</h4>
                    <ol>
                        <li>Right-click extension icon ‚Üí Options</li>
                        <li>Change keyboard shortcuts, default speed, etc.</li>
                        <li>Save settings</li>
                        <li>Reload this test page</li>
                        <li>Test that your changes work with media controls above</li>
                        <li>Verify settings persist after browser restart</li>
                    </ol>
                </div>
            `;
        }
        
        function resetToDefaults() {
            if (confirm('This will attempt to reset extension settings to defaults. Continue?')) {
                showTestResult('Reset to defaults requested - check extension options page', 'warning');
                
                document.getElementById('settingsTestResults').innerHTML = `
                    <div class="warning-box">
                        <strong>Reset Requested:</strong> Go to extension options page and use the reset/restore defaults option if available.
                    </div>
                `;
            }
        }
        
        // Automated Test Functions
        function runAllTests() {
            showTestResult('üöÄ Starting comprehensive test suite...', 'info');
            
            setTimeout(() => runSpeedTests(), 500);
            setTimeout(() => runVolumeTests(), 2000);
            setTimeout(() => runKeyboardTests(), 4000);
            setTimeout(() => runMediaTests(), 6000);
            
            showTestResult('All automated tests initiated. See results below.', 'success');
        }
        
        function runSpeedTests() {
            showTestResult('‚ö° Testing speed controls...', 'info');
            
            const speeds = [0.5, 1.0, 1.5, 2.0, 1.0];
            let testIndex = 0;
            
            function testNextSpeed() {
                if (testIndex < speeds.length) {
                    setSpeed(speeds[testIndex]);
                    
                    // Verify speed was set
                    if (Math.abs(video.playbackRate - speeds[testIndex]) < 0.01) {
                        showTestResult(`‚úÖ Speed ${speeds[testIndex]}x test passed`, 'pass');
                    } else {
                        showTestResult(`‚ùå Speed ${speeds[testIndex]}x test failed`, 'fail');
                    }
                    
                    testIndex++;
                    setTimeout(testNextSpeed, 800);
                } else {
                    showTestResult('‚ö° Speed tests completed', 'success');
                }
            }
            
            if (!video.paused) {
                testNextSpeed();
            } else {
                playVideo();
                setTimeout(testNextSpeed, 500);
            }
        }
        
        function runVolumeTests() {
            showTestResult('üîä Testing volume controls...', 'info');
            
            const volumes = [1.0, 1.5, 2.0, 1.0];
            let testIndex = 0;
            
            function testNextVolume() {
                if (testIndex < volumes.length) {
                    setVolume(volumes[testIndex]);
                    
                    // Verify volume was set in our test state
                    if (Math.abs(testVolume - volumes[testIndex]) < 0.01) {
                        showTestResult(`‚úÖ Volume ${(volumes[testIndex] * 100).toFixed(0)}% test passed`, 'pass');
                    } else {
                        showTestResult(`‚ùå Volume ${(volumes[testIndex] * 100).toFixed(0)}% test failed`, 'fail');
                    }
                    
                    testIndex++;
                    setTimeout(testNextVolume, 1000);
                } else {
                    showTestResult('üîä Volume tests completed', 'success');
                }
            }
            
            testNextVolume();
        }
        
        function runKeyboardTests() {
            showTestResult('‚å®Ô∏è Testing keyboard shortcuts...', 'info');
            showTestResult('Note: Keyboard tests require manual verification', 'warning');
            
            const shortcuts = [
                { key: 'V', desc: 'Show/Hide Controller' },
                { key: 'S', desc: 'Decrease Speed' },
                { key: 'D', desc: 'Increase Speed' },
                { key: 'R', desc: 'Reset Speed' },
                { key: 'G', desc: 'Fast Speed' },
                { key: 'M', desc: 'Set Marker' },
                { key: 'J', desc: 'Jump to Marker' },
                { key: '‚Üë', desc: 'Volume Up' },
                { key: '‚Üì', desc: 'Volume Down' }
            ];
            
            shortcuts.forEach((shortcut, index) => {
                setTimeout(() => {
                    showTestResult(`‚å®Ô∏è Test ${shortcut.key} key for ${shortcut.desc}`, 'info');
                }, index * 300);
            });
            
            setTimeout(() => {
                showTestResult('‚å®Ô∏è Keyboard tests completed - verify manually', 'warning');
            }, shortcuts.length * 300 + 500);
        }
        
        function runMediaTests() {
            showTestResult('üì∫ Testing media detection and tracking...', 'info');
            
            // Test marker functionality
            setTimeout(() => {
                setMarker();
                showTestResult('‚úÖ Marker set test completed', 'pass');
            }, 500);
            
            setTimeout(() => {
                jumpToMarker();
                showTestResult('‚úÖ Jump to marker test completed', 'pass');
            }, 1000);
            
            setTimeout(() => {
                rewind(5);
                showTestResult('‚úÖ Rewind test completed', 'pass');
            }, 1500);
            
            setTimeout(() => {
                advance(5);
                showTestResult('‚úÖ Advance test completed', 'pass');
            }, 2000);
            
            setTimeout(() => {
                showTestResult('üì∫ Media tests completed', 'success');
            }, 2500);
        }
        
        // Console logging for debugging
        console.log('üöÄ UME Test Suite loaded');
        console.log('Use browser console to see extension debug messages');
        console.log('Available test functions:', {
            runAllTests,
            runSpeedTests,
            runVolumeTests,
            runKeyboardTests,
            testTabTracking,
            testSettingsLoad
        });
        
        // Page visibility API for testing
        document.addEventListener('visibilitychange', () => {
            console.log('Page visibility changed:', document.hidden ? 'hidden' : 'visible');
            showTestResult(`Page visibility: ${document.hidden ? 'hidden' : 'visible'}`, 'info');
        });
        
        // Initialize displays
        document.addEventListener('DOMContentLoaded', () => {
            updateVolumeDisplay(1.0);
            showTestResult('üöÄ UME Comprehensive Test Suite ready!', 'success');
            showTestResult('Load the UME extension and start testing features above.', 'info');
        });
    </script>
</body>
</html> 